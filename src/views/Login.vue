<template>
    <div class="container-layout">
        <div class="header">
            <span>easypan</span>
        </div>
        <div class="container">
            <div class="login-register">
                <span class="login-register-title" v-if="opType == 0">Login</span>
                <span class="login-register-title" v-if="opType == 1 || opType == 2">Sign Up</span>

                <ElForm class="login-register" :model="formData" ref="formDataRef" :rules="rules" :label-width="0">
                    <ElFormItem class="input-item" prop="email">
                        <!-- ÈááÁî®ÁªùÂØπÂÆö‰ΩçËÑ±Á¶ªÊñáÊ°£Ôºå‰∏çÁÑ∂ÊääËæìÂÖ•Ê°ÜÊíë‰∏ãÂéªÔºå‰∏çÂ•ΩÁúã -->
                        <span class="input-tip" v-if="formData.email">ÈÇÆÁÆ±</span>
                        <ElInput v-model="formData.email" clearable placeholder="ÈÇÆÁÆ±" :maxlength="110">
                        </ElInput>

                        <div class="checkCode-btn" v-if="opType == 1 || opType == 2">
                            <ElButton color="#626aef" size="small" @click="sendEmailCode">Ëé∑ÂèñÈ™åËØÅÁ†Å</ElButton>
                        </div>
                    </ElFormItem>

                    <ElFormItem class="input-item" prop="password" v-if="opType == 0">
                        <span class="input-tip" v-if="formData.password">ÂØÜÁ†Å</span>
                        <ElInput v-model="formData.password" clearable placeholder="ÂØÜÁ†Å" show-password>
                        </ElInput>
                    </ElFormItem>

                    <!-- Ê≥®ÂÜåÊó∂ÊâçÊúâÁöÑ -->
                    <div v-if="opType == 1 || opType == 2">

                        <ElFormItem class="input-item" prop="emailCode">
                            <span class="input-tip" v-if="formData.emailCode">ÈÇÆÁÆ±È™åËØÅÁ†Å</span>
                            <ElInput v-model="formData.emailCode" clearable placeholder="ÈÇÆÁÆ±È™åËØÅÁ†Å">
                            </ElInput>
                        </ElFormItem>

                        <ElFormItem v-if="opType == 1" class="input-item" prop="nickName">
                            <span class="input-tip" v-if="formData.nickName">ÊòµÁß∞</span>
                            <ElInput v-model="formData.nickName" clearable placeholder="ÊòµÁß∞">
                            </ElInput>
                        </ElFormItem>

                        <ElFormItem class="input-item" prop="registerPassword">
                            <span class="input-tip" v-if="formData.registerPassword">ÂØÜÁ†Å</span>
                            <ElInput v-model="formData.registerPassword" clearable placeholder="ÂØÜÁ†Å" show-password>
                            </ElInput>
                        </ElFormItem>

                        <ElFormItem class="input-item" prop="reRegisterPassword">
                            <span class="input-tip" v-if="formData.reRegisterPassword">ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å</span>
                            <ElInput v-model="formData.reRegisterPassword" clearable placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å"
                                show-password>
                            </ElInput>
                        </ElFormItem>
                    </div>

                    <ElFormItem class="input-item" prop="checkCode">
                        <span class="input-tip" v-if="formData.checkCode">È™åËØÅÁ†Å</span>

                        <ElInput v-model="formData.checkCode" placeholder="È™åËØÅÁ†Å" :maxlength="5">
                        </ElInput>

                        <img class="checkCode" :src="checkCodeUrl" @click="changeCheckCode(0)">
                    </ElFormItem>

                    <ElFormItem>
                        <div class="submit-login">
                            <ElButton size="large" color="#626aef" class="login-button" type="primary" round
                                @click="dosubmit">{{
                                    buttonName }}
                            </ElButton>
                        </div>
                    </ElFormItem>

                    <ElFormItem>
                        <div class="forget-password">
                            <span v-if="opType == 0" @click="changeToStatus(2)">ÂøòËÆ∞ÂØÜÁ†Å</span>
                        </div>
                    </ElFormItem>

                    <ElFormItem v-if="opType == 0">
                        <div class="login-in-qq">
                            <span class="qq-button">üêß</span>
                        </div>
                    </ElFormItem>

                    <ElFormItem>
                        <div class="forget-password">

                            <span v-if="opType == 0" @click="changeToStatus(1)">Ê≤°ÊúâË¥¶Âè∑ÔºüÊ≥®ÂÜå‰∏Ä‰∏™</span>
                            <span v-if="opType == 1 || opType == 2" @click="changeToStatus(0)">Â∑≤ÊúâË¥¶Âè∑ÔºüÂéªÁôªÂΩï</span>
                        </div>
                    </ElFormItem>
                </ElForm>

            </div>

            <Dialog class="send-email-dialog" :show="dialogConfig4SendEmail.show" :title="dialogConfig4SendEmail.title"
                ref="dialog4SendEmailRef" @close="closeDialog" width="90%" :show-cancel="false">
                <ElForm :model="sendEmailFormData" ref="sendEmailFormDataRef" :rules="rules">
                    <ElFormItem label="ÂèëÈÄÅÂà∞ÈÇÆÁÆ±:">
                        {{ sendEmailFormData.email }}
                    </ElFormItem>
                    <ElFormItem class="input-item" prop="checkCode">
                        <img :src="checkCode4SendEmail" @click="changeCheckCode(1)">
                        <ElInput v-model="sendEmailFormData.checkCode" maxlength="5" style="width: 50%;"></ElInput>
                    </ElFormItem>

                    <ElFormItem>
                        <div class="send-email-code-btn">
                            <ElButton color="#626aef" @click="getEmailCode">Ëé∑ÂèñÈÇÆÁÆ±È™åËØÅÁ†Å</ElButton>
                        </div>
                    </ElFormItem>
                </ElForm>
            </Dialog>
        </div>


    </div>
</template>

<script setup>
import { ElInput, ElForm, ElFormItem, ElButton } from 'element-plus';
import { getCurrentInstance, nextTick, reactive, ref } from 'vue';
import Dialog from '../components/Dialog.vue';
import { useRoute, useRouter } from 'vue-router';
import md5 from 'js-md5';

const { proxy } = getCurrentInstance()

const router = useRouter()
const route = useRoute()

const formData = ref({})
const formDataRef = ref()

const api = {
    checkCode: "/api/checkCode",
    sendEmailCode: "/sendEmailCode",
    register: "/register",
    login: "/login",
    resetPassword: "/ResetPwd"
}

//Ê†°È™å‰∏§Ê¨°ËæìÂÖ•ÊòØÂê¶Áõ∏Âêå
const checkRegisterPassword = (rule, value, callback) => {
    if (value != formData.value.registerPassword) {
        callback(new Error(rule.message))
    } else {
        callback()
    }
}

const rules = {
    email: [
        { required: true, message: "ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" },
        { max: 150, message: "ÈÇÆÁÆ±‰∏çËÉΩË∂ÖËøá150Â≠óÁ¨¶" },
        { validator: proxy.verify.email, message: "ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÈÇÆÁÆ±Ê†ºÂºè" }
    ],
    emailCode: [{ required: true, message: "ÈÇÆÁÆ±È™åËØÅÁ†Å‰∏çËÉΩ‰∏∫Á©∫" }],
    password: [
        {
            required: true, message: "ËØ∑ËæìÂÖ•ÂØÜÁ†Å"
        }
    ],
    registerPassword: [{
        required: true, message: "ÂØÜÁ†Å‰∏çËÉΩ‰∏∫Á©∫",
    }, {
        max: 18, message: "ÈúÄ‰∏∫Êï∞Â≠ó,Â∞èÂÜô,Â§ßÂÜôÂ≠óÊØç,ÁâπÊÆäÁ¨¶Âè∑.ÈïøÂ∫¶‰∏∫8-18‰Ωç"
    }, {
        min: 8, message: "ÈúÄ‰∏∫Êï∞Â≠ó,Â∞èÂÜô,Â§ßÂÜôÂ≠óÊØç,ÁâπÊÆäÁ¨¶Âè∑.ÈïøÂ∫¶‰∏∫8-18‰Ωç"
    }, {
        validator: proxy.verify.password, message: "ÈúÄ‰∏∫Êï∞Â≠ó,Â∞èÂÜô,Â§ßÂÜôÂ≠óÊØç,ÁâπÊÆäÁ¨¶Âè∑.ÈïøÂ∫¶‰∏∫8-18‰Ωç"
    },
    ], reRegisterPassword: [{
        validator: checkRegisterPassword, message: "‰∏§Ê¨°ÂØÜÁ†ÅËæìÂÖ•‰∏ç‰∏ÄËá¥"
    }], nickName: [
        { required: true, message: "ÊòµÁß∞‰∏çËÉΩ‰∏∫Á©∫" }
    ], checkCode: [{ required: true, message: "ËØ∑ËæìÂÖ•È™åËØÅÁ†Å" }]
}
const opType = ref(0)
const buttonName = ref("ÁôªÂΩï")

const changeToStatus = (type) => {


    formDataRef.value.resetFields()

    opType.value = type

    if (type == 0) {
        buttonName.value = "ÁôªÂΩï"
    } else if (type == 1) {
        buttonName.value = "Ê≥®ÂÜå"
    }

    changeCheckCode(0)
}

const checkCodeUrl = ref(api.checkCode)
const checkCode4SendEmail = ref(api.checkCode)

const changeCheckCode = (type) => {
    if (type == 0) {
        checkCodeUrl.value = api.checkCode + "?type=" + type + "&time=" + new Date().getTime();
    } else {
        checkCode4SendEmail.value = api.checkCode + "?type=" + type + "&time=" + new Date().getTime();
    }
}

const dialog4SendEmailRef = ref()
let dialogConfig4SendEmail = reactive({
    show: false,
    title: "ÈÇÆÁÆ±È™åËØÅÁ†Å",
})

const sendEmailFormData = ref({})
const sendEmailFormDataRef = ref()

const sendEmailCode = () => {
    formDataRef.value.validateField("email", (valid) => {
        if (!valid) {
            return
        }

        dialogConfig4SendEmail.show = true

        nextTick(() => {
            changeCheckCode(1)
            sendEmailFormDataRef.value.resetFields()
            sendEmailFormData.value = {
                email: formData.value.email
            }
        })
    })

}

const closeDialog = () => {
    dialogConfig4SendEmail.show = false
}

const getEmailCode = () => {
    sendEmailFormDataRef.value.validate(async (valid) => {
        if (!valid) {
            return
        }

        let params = {}
        Object.assign(params, sendEmailFormData.value)
        params.type = opType.value == 0 ? 0 : 1

        let result = await proxy.request({
            url: api.sendEmailCode,
            params: params,
            errorCallback: () => {
                changeCheckCode(1)
            }
        })

        if (!result) {
            return
        }

        proxy.message.success("ÂèëÈÄÅÊàêÂäü")

        dialogConfig4SendEmail.show = false
    })
}

const dosubmit = () => {
    formDataRef.value.validate(async (valid) => {
        if (!valid) {
            return
        }

        let params = {}
        Object.assign(params, formData.value);

        const url = ref()

        if (opType.value == 0) {
            url.value = api.login

            params.password = md5(formData.value.password)
        } else if (opType.value == 1) {
            url.value = api.register

            params.password = md5(formData.value.registerPassword)
        } else {
            url.value = api.resetPassword

            params.password = md5(formData.value.registerPassword)
        }

        console.log(url.value)

        let result = await proxy.request({
            url: url.value,
            params: params,
            errorCallback: () => {
                changeCheckCode(0)
            }
        })

        if (!result) {
            return
        }

        if (opType.value == 1) {
            proxy.message.success("Ê≥®ÂÜåÊàêÂäü")

            opType.value = 0

        } else if (opType.value == 0) {
            proxy.message.success("ÁôªÂΩïÊàêÂäü")

            //ÁôªÂΩïÊàêÂäüÔºåÂ≠òÂÇ®cookies
            console.log(result.data)
            proxy.vueCookies.set("userInfo", result.data)

            router.push("/")
        } else if (opType.value == 2) {
            proxy.message.success("ÈáçÁΩÆÂØÜÁ†ÅÊàêÂäü")
        }


        formDataRef.value.resetFields()

    })
}

</script>
<style lang="scss">
.header {
    color: #626aef;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 75px 0px;
    font-size: 50px;
    font-weight: bolder;
}

.container {
    .login-register {
        .login-register-title {
            font-size: 25px;
            font-weight: bold;
            color: rgb(88, 88, 88);
        }

        .login-register {
            .input-item {
                margin: 33px 0px;
                position: relative;

                .input-tip {
                    position: absolute;
                    bottom: 22px;

                    font-size: small;
                    color: rgb(164, 158, 158);
                }

                .checkCode-btn {
                    position: absolute;
                    right: 0px;
                    top: 25px;
                    margin-top: 3px;
                }

                .checkCode {
                    position: absolute;
                    right: 0px;
                }
            }


            margin-top: 35px;

            .el-input__wrapper {
                box-shadow: 0px -1px 0 0px var(--el-input-hover-border-color) inset;
                border-radius: 0;
                padding: 0px;

                &.is-focus {
                    box-shadow: 0px -1px 0 0px var(--el-input-focus-border-color) inset;

                }
            }

            .submit-login {
                display: flex;
                justify-content: center;
                width: 100%;

                .login-button {
                    width: 90%;
                    height: 100%;
                }
            }

            .forget-password {
                display: flex;
                justify-content: center;
                color: rgb(136, 136, 136);
                width: 100%;
                cursor: pointer;
            }

            .login-in-qq {
                display: flex;
                justify-content: center;
                width: 100%;

                .qq-button {
                    font-size: 20px;
                }
            }
        }

    }

    .send-email-dialog {
        .input-item {
            .el-form-item__content {
                flex-wrap: nowrap;
                justify-content: space-between;
            }

            .el-input__wrapper {
                box-shadow: 0px -1px 0 0px var(--el-input-hover-border-color) inset;
                border-radius: 0;
                padding: 0px;

                &.is-focus {
                    box-shadow: 0px -1px 0 0px var(--el-input-focus-border-color) inset;
                }
            }
        }

        .send-email-code-btn {
            width: 100%;
            display: flex;
            justify-content: end;
        }
    }
}
</style>